<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Golf League</title>
    <style>
        /* Basic CSS for presentation - you can expand this */
        body { font-family: Arial, sans-serif; margin: 20px; }
        #app-container { max-width: 800px; margin: auto; }
        .screen { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .form-control { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .roster-selection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .player-item { border: 1px solid #ddd; padding: 10px; }
        .roster-player { display: block; font-weight: normal; }
        .roster-player:nth-child(odd) { background-color: #f9f9f9; }
        .roster-player:nth-child(even) { background-color: #fff; }
        
        /* Scoreboard Styles */
        #scoreboard table { width: 100%; border-collapse: collapse; }
        #scoreboard th, #scoreboard td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #scoreboard th { background-color: #f2f2f2; }
        .team-name { font-weight: bold; }
        .roster-list { list-style: none; padding: 0; margin: 5px 0 0 0; font-size: 0.9em; }
    </style>
    <script src="fantasy_data.js"></script>
</head>
<body>

<div id="app-container">
    <h1>Fantasy League</h1>

    <div id="login-screen" class="screen">
        <h2>Enter Your Name</h2>
        <div class="form-control">
            <label for="user-name">Your Name:</label>
            <input type="text" id="user-name" required>
        </div>
        <button onclick="loginUser()">Login / Start Setup</button>
    </div>

    <div id="setup-screen" class="screen" style="display:none;">
        <h2 id="setup-welcome"></h2>

        <div class="form-control">
            <label for="overall-winner">Overall Winner Pick (20 Point Bonus):</label>
            <select id="overall-winner" required>
                <option value="">-- Select Team --</option>
                <option value="USA">USA</option>
                <option value="EUR">Europe</option>
            </select>
        </div>

        <h3>Daily Double Player Picks (Points are doubled for this player on this day)</h3>
        <div class="form-control">
            <label for="day-winner-friday">Friday Day Winner (Player):</label>
            <select id="day-winner-friday" required>
                </select>
        </div>
        <div class="form-control">
            <label for="day-winner-saturday">Saturday Day Winner (Player):</label>
            <select id="day-winner-saturday" required>
                </select>
        </div>
        <div class="form-control">
            <label for="day-winner-sunday">Sunday Day Winner (Player):</label>
            <select id="day-winner-sunday" required>
                </select>
        </div>

        <h3>Roster Selection (Select 8 Players)</h3>
        <p id="roster-count">Selected: 0/8</p>
        <div id="roster-selection" class="roster-selection">
            </div>

        <button onclick="saveTeamSetup()">Save Team & View Scoreboard</button>
    </div>

    <div id="scoreboard-screen" class="screen" style="display:none;">
        <h2>Current Standings</h2>
        <div id="scoreboard">
            </div>
    </div>
</div>

<script>
    let currentUserName = '';

    function loginUser() {
        const userNameInput = document.getElementById('user-name').value.trim();
        if (userNameInput) {
            currentUserName = userNameInput;
            document.getElementById('login-screen').style.display = 'none';
            renderSetupScreen();
            document.getElementById('setup-screen').style.display = 'block';
        } else {
            alert('Please enter your name.');
        }
    }

    function renderSetupScreen() {
        document.getElementById('setup-welcome').textContent = `Setup Team for ${currentUserName}`;

        // --- 1. Populate Day Winner Selects (Player-Based) ---
        const dayWinners = ['day-winner-friday', 'day-winner-saturday', 'day-winner-sunday'];
        
        dayWinners.forEach(selectId => {
            const select = document.getElementById(selectId);
            const currentValue = select.value; 
            select.innerHTML = '<option value="">-- Select Player --</option>'; 
            
            // Combine and sort players alphabetically
            const sortedPlayers = [...PLAYERS].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedPlayers.forEach(player => {
                const option = document.createElement('option');
                // The value is the player's ID, the text is their name and team
                option.value = player.id; 
                option.textContent = `${player.name} (${player.team})`;
                select.appendChild(option);
            });
            select.value = currentValue; 
        });

        // --- 2. Populate Roster Selection Checkboxes (All 24 Players) ---
        const rosterDiv = document.getElementById('roster-selection');
        rosterDiv.innerHTML = ''; // Clear previous content

        // Sort players by Team (USA/EUR) then alphabetically
        const sortedRoster = [...PLAYERS].sort((a, b) => {
            if (a.team !== b.team) {
                return a.team.localeCompare(b.team);
            }
            return a.name.localeCompare(b.name);
        });

        sortedRoster.forEach(player => {
            const playerItem = document.createElement('label');
            playerItem.className = 'roster-player';
            playerItem.innerHTML = `
                <input type="checkbox" name="roster" value="${player.id}" onchange="updateRosterCount()">
                ${player.name} (${player.team})
            `;
            rosterDiv.appendChild(playerItem);
        });

        updateRosterCount(); // Initial count update
    }

    function updateRosterCount() {
        const selectedCount = document.querySelectorAll('#roster-selection input:checked').length;
        document.getElementById('roster-count').textContent = `Selected: ${selectedCount}/8`;

        // Disable/Enable logic
        const checkboxes = document.querySelectorAll('#roster-selection input[type="checkbox"]');
        if (selectedCount >= 8) {
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = true;
                }
            });
        } else {
            checkboxes.forEach(cb => {
                cb.disabled = false;
            });
        }
    }

    function saveTeamSetup() {
        const overallPick = document.getElementById('overall-winner').value;
        const fridayPick = document.getElementById('day-winner-friday').value;
        const saturdayPick = document.getElementById('day-winner-saturday').value;
        const sundayPick = document.getElementById('day-winner-sunday').value;
        const rosterCheckboxes = document.querySelectorAll('#roster-selection input:checked');

        // Validation
        if (!overallPick || !fridayPick || !saturdayPick || !sundayPick) {
            alert('Please make a selection for Overall Winner and all three Daily Double Players.');
            return;
        }

        if (rosterCheckboxes.length !== 8) {
            alert('You must select exactly 8 players for your roster.');
            return;
        }

        const dayWinners = {
            'Friday': fridayPick,   // Now stores Player ID
            'Saturday': saturdayPick, // Player ID
            'Sunday': sundayPick      // Player ID
        };

        // Check for duplicate player picks in Daily Doubles
        const dailyPicks = Object.values(dayWinners);
        const uniquePicks = new Set(dailyPicks);
        if (uniquePicks.size !== dailyPicks.length) {
            alert('A player cannot be selected as the Daily Double Player for more than one day.');
            return;
        }

        // Build new team object
        const newTeam = {
            name: currentUserName,
            overallPick: overallPick,
            roster: Array.from(rosterCheckboxes).map(cb => cb.value),
            dayWinners: dayWinners, 
            totalPoints: 0
        };

        // Add to LEAGUE_DATA or update existing
        const existingIndex = LEAGUE_DATA.fantasyTeams.findIndex(t => t.name === currentUserName);
        if (existingIndex !== -1) {
            LEAGUE_DATA.fantasyTeams[existingIndex] = newTeam;
        } else {
            LEAGUE_DATA.fantasyTeams.push(newTeam);
        }

        // Switch to scoreboard
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('scoreboard-screen').style.display = 'block';
        
        calculateAndRenderScoreboard();
    }

    function calculateAllScores() {
        // 1. Determine Actual Overall Winner
        const totalUSA = Object.values(LEAGUE_DATA.matchScores.USA).reduce((a, b) => a + b, 0);
        const totalEUR = Object.values(LEAGUE_DATA.matchScores.EUR).reduce((a, b) => a + b, 0);
        
        let actualOverallWinner = 'TIE';
        if (totalUSA > totalEUR) {
            actualOverallWinner = 'USA';
        } else if (totalEUR > totalUSA) {
            actualOverallWinner = 'EUR';
        }

        // 2. Clear previous scores
        LEAGUE_DATA.fantasyTeams.forEach(team => {
            team.totalPoints = 0;
            team.bonusPoints = 0; // Initialize bonus points for display
        });
        
        // 3. Apply Player Points to Fantasy Teams
        LEAGUE_DATA.fantasyTeams.forEach(team => {
            let teamPoints = 0;
            
            // Get points for each roster player
            team.roster.forEach(playerId => {
                const playerScores = LEAGUE_DATA.playerScores[playerId];
                if (playerScores) {
                    let playerTotal = playerScores.total;
                    
                    // --- Apply Player Day Winner Multiplier ---
                    
                    // Check Friday
                    if (team.dayWinners.Friday === playerId) {
                         // Double the points scored by *this player* on *Friday*
                         playerTotal += playerScores.Friday; 
                    }
                    // Check Saturday
                    if (team.dayWinners.Saturday === playerId) {
                         playerTotal += playerScores.Saturday; 
                    }
                    // Check Sunday
                    if (team.dayWinners.Sunday === playerId) {
                         playerTotal += playerScores.Sunday; 
                    }
                    
                    teamPoints += playerTotal;
                }
            });

            // 4. Apply Overall Winner Bonus
            let bonusPoints = 0;
            if (team.overallPick === actualOverallWinner) {
                bonusPoints = SCORING_RULES.overallWinnerBonus;
            }

            team.totalPoints = teamPoints + bonusPoints;
            team.bonusPoints = bonusPoints; // Store bonus points separately for display
        });

        // 5. Sort teams by total points (descending)
        LEAGUE_DATA.fantasyTeams.sort((a, b) => b.totalPoints - a.totalPoints);
    }

    function calculateAndRenderScoreboard() {
        calculateAllScores();
        
        const scoreboardDiv = document.getElementById('scoreboard');
        let html = '<table>';
        html += '<thead><tr><th>Rank</th><th>Fantasy Team</th><th>Player Points</th><th>Bonus Points</th><th>Total Points</th></tr></thead>';
        html += '<tbody>';
        
        LEAGUE_DATA.fantasyTeams.forEach((team, index) => {
            // Find player names for Day Winners
            const getPlayerName = (id) => PLAYERS.find(p => p.id === id)?.name || id;

            html += `<tr>`;
            html += `<td>${index + 1}</td>`;
            html += `<td class="team-name">${team.name}<br>
                         <ul class="roster-list">
                             <li>Pick: ${team.overallPick}</li>
                             <li>Fri Double: ${getPlayerName(team.dayWinners.Friday)}</li>
                             <li>Sat Double: ${getPlayerName(team.dayWinners.Saturday)}</li>
                             <li>Sun Double: ${getPlayerName(team.dayWinners.Sunday)}</li>
                         </ul>
                     </td>`;
            html += `<td>${team.totalPoints - team.bonusPoints}</td>`; // Player Points only
            html += `<td>${team.bonusPoints}</td>`; // Bonus Points
            html += `<td><strong>${team.totalPoints}</strong></td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        
        // Add actual match score summary (unchanged)
        const totalUSA = Object.values(LEAGUE_DATA.matchScores.USA).reduce((a, b) => a + b, 0);
        const totalEUR = Object.values(LEAGUE_DATA.matchScores.EUR).reduce((a, b) => a + b, 0);
        const actualWinner = totalUSA > totalEUR ? 'USA' : totalEUR > totalUSA ? 'Europe' : 'TIE';

        html += `<h3>Match Score: USA ${totalUSA} - ${totalEUR} Europe (Winner: ${actualWinner})</h3>`;
        html += `<p>This scoreboard is based on the data in <code>fantasy_data.js</code>.</p>`;
        
        scoreboardDiv.innerHTML = html;
    }

    // Initial check (if a user is already "logged in" by refreshing)
    if (currentUserName) {
        renderSetupScreen();
    }
</script>

</body>
</html>
